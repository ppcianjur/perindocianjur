<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cetak KTA Perindo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image-more/3.3.0/dom-to-image-more.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        /* Font Calibri sebagai font utama */
        body {
            background-color: #e2e8f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            font-family: 'Calibri', sans-serif; 
        }

        .kta-card {
            width: 85.6mm;
            height: 107.96mm; 
            background-image: url('/kta_blanko.png');
            background-size: 100% 100%; 
            background-repeat: no-repeat;
            position: relative;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            overflow: hidden;
            color: #000;
            background-color: white;
            image-rendering: -webkit-optimize-contrast;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        /* --- POSISI DATA --- */

        /* 1. Foto Anggota (TURUN 5px -> Jadi 23mm) */
        .photo-area {
            position: absolute;
            top: 23mm;      
            left: 4.5mm;    
            width: 15mm;
            height: 19mm;
            object-fit: cover;
            border-radius: 2px;
            z-index: 10;
            background-color: #ddd;
            border: none !important; 
            outline: none !important;
        }

        /* 2. Area Teks Data (Tetap di 21mm sesuai request sebelumnya) */
        .text-area {
            position: absolute;
            top: 21mm; 
            left: 21mm; 
            width: 44mm; 
            padding-left: 2.5mm; 
            box-sizing: border-box; 
            line-height: 1.15;
            z-index: 10;
            border: none !important;
            outline: none !important;
            background: transparent !important;
        }

        .text-area * {
            border: none !important; outline: none !important; background: transparent !important;
        }

        /* 3. QR CODE AREA (TURUN 5px -> Jadi 23mm) */
        .qr-area {
            position: absolute;
            top: 23mm;  
            right: 5mm;   
            width: 15.5mm;
            height: 15.5mm;
            background-color: white; 
            z-index: 10;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1px; 
        }
        .qr-area img {
            width: 100%;
            height: auto;
        }

        /* --- STYLE FONT (CALIBRI) --- */
        
        .kta-number {
            font-family: 'Calibri', sans-serif; 
            font-size: 9pt; 
            font-weight: 700; 
            color: #000000; 
            letter-spacing: 0px; 
            margin-top: 5px; 
            margin-bottom: 0px;
            line-height: 1.1;
        }

        .kta-name {
            font-family: 'Calibri', sans-serif; 
            font-size: 9pt; 
            font-weight: 700; 
            text-transform: uppercase; 
            margin-bottom: 3px; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            color: #000000;
            line-height: 1.1;
        }

        .kta-details {
            font-family: 'Calibri', sans-serif; 
            font-size: 6.5pt; 
            font-weight: 400; 
            color: #000000; 
            line-height: 1.25;
        }

        @media print {
            body { background: white; margin: 0; padding: 0; display: flex; justify-content: center; align-items: flex-start; }
            .no-print { display: none !important; }
            .kta-card { box-shadow: none; margin-top: 5mm; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }
    </style>
</head>
<body>

    <div class="no-print mb-6 flex gap-3 flex-wrap justify-center">
        <button onclick="downloadImage()" class="bg-green-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-green-700 flex items-center gap-2 shadow-lg transition-transform active:scale-95">
            <i data-lucide="download" class="w-5 h-5"></i> Download PNG (HD)
        </button>
        <button onclick="window.print()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700 flex items-center gap-2 shadow-lg transition-transform active:scale-95">
            <i data-lucide="printer" class="w-5 h-5"></i> Cetak / PDF
        </button>
        <button onclick="window.close()" class="bg-slate-200 text-slate-700 px-6 py-2 rounded-lg font-bold hover:bg-slate-300">
            Tutup
        </button>
    </div>

    <div class="kta-card" id="card">
        <img id="imgFoto" src="https://via.placeholder.com/150" class="photo-area" crossorigin="anonymous">
        
        <div class="text-area">
            <div id="txtKta" class="kta-number">LOADING...</div>
            <div id="txtNama" class="kta-name">LOADING...</div>
            <div class="kta-details">
                <div id="txtTtl">...</div>
                <div id="txtAlamat" style="margin-top: 1px;">...</div>
                <div id="txtHp" style="margin-top: 2px;">...</div>
            </div>
        </div>

        <div id="qrcode" class="qr-area"></div>
    </div>

    <script>
        lucide.createIcons();

        async function loadData() {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');
            const nik = params.get('nik');

            if (!id && !nik) {
                alert("Data tidak ditemukan (ID/NIK kosong).");
                generateQR();
                return;
            }

            try {
                const res = await fetch(`/api/get-kta?${id ? 'id='+id : 'nik='+nik}`);
                const data = await res.json();

                if (data.error) throw new Error(data.error);

                document.getElementById('txtKta').innerText = data.no_kta || "-";
                document.getElementById('txtNama').innerText = data.nama || "-";
                
                const tgl = data.tanggal_lahir || "";
                document.getElementById('txtTtl').innerText = `${data.tempat_lahir || 'CIANJUR'} / ${tgl}`;

                let baris1 = `${data.alamat || ''} RT.${data.rt}/${data.rw}, ${data.nama_desa}, ${data.nama_kecamatan}, KABUPATEN CIANJUR`.toUpperCase();
                if(baris1.length > 85) baris1 = baris1.substring(0, 82) + "...";

                document.getElementById('txtAlamat').innerHTML = `${baris1}<br>JAWA BARAT`;
                document.getElementById('txtHp').innerText = `Telp : ${data.no_hp_format || '-'}`;

                if (data.foto_orang_url) {
                    document.getElementById('imgFoto').src = data.foto_orang_url;
                } else if (data.foto_url) {
                    document.getElementById('imgFoto').src = data.foto_url; 
                }
                
                generateQR();

            } catch (e) {
                alert("Gagal memuat data: " + e.message);
            }
        }

        // FUNGSI GENERATE QR CODE
        function generateQR() {
            const qrContainer = document.getElementById("qrcode");
            qrContainer.innerHTML = ""; 

            new QRCode(qrContainer, {
                text: "https://partaiperindo.com/", 
                width: 128, 
                height: 128,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H 
            });
        }

        // FUNGSI DOWNLOAD PNG (DOM-TO-IMAGE-MORE)
        function downloadImage() {
            const card = document.getElementById('card');
            const namaFile = document.getElementById('txtNama').innerText || 'KTA_PERINDO';
            document.body.style.cursor = 'wait';
            const scale = 4;

            domtoimage.toPng(card, {
                width: card.clientWidth * scale,
                height: card.clientHeight * scale,
                style: {
                    transform: `scale(${scale})`,
                    transformOrigin: 'top left',
                    width: `${card.clientWidth}px`,
                    height: `${card.clientHeight}px`,
                    'border': 'none',
                    'outline': 'none'
                }
            })
            .then(function (dataUrl) {
                const link = document.createElement('a');
                link.download = `KTA_${namaFile.replace(/[^a-zA-Z0-9]/g, '_')}.png`;
                link.href = dataUrl;
                link.click();
                document.body.style.cursor = 'default';
            })
            .catch(function (error) {
                console.error('oops, something went wrong!', error);
                alert("Gagal render gambar: " + error);
                document.body.style.cursor = 'default';
            });
        }

        loadData();
    </script>
</body>
</html>
