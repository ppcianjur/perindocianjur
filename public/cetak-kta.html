<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cetak KTA Perindo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Arimo:wght@400;700;800&display=swap');

        body {
            background-color: #e2e8f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            font-family: 'Arimo', sans-serif;
        }

        .kta-card {
            width: 85.6mm;
            height: 107.96mm; 
            background-image: url('/kta_blanko.png');
            background-size: 100% 100%; 
            background-repeat: no-repeat;
            position: relative;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            overflow: hidden;
            color: #000;
            background-color: white;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        /* --- POSISI DATA (TETAP SESUAI PERMINTAAN TERAKHIR) --- */

        /* 1. Foto Anggota */
        .photo-area {
            position: absolute;
            top: 24.5mm;      
            left: 4.5mm;    
            width: 15mm;
            height: 19mm;
            object-fit: cover;
            border-radius: 2px;
            z-index: 10;
            background-color: #ddd;
        }

        /* 2. Area Teks Data */
        .text-area {
            position: absolute;
            top: 24mm;
            left: 21mm; 
            width: 44mm; 
            padding-left: 2.5mm; 
            box-sizing: border-box; 
            line-height: 1.15;
            z-index: 10;
        }

        .kta-number {
            font-size: 10pt;
            font-weight: 800;
            margin-bottom: 2px;
            letter-spacing: 0.5px;
        }

        .kta-name {
            font-size: 8pt;
            font-weight: 800;
            text-transform: uppercase;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .kta-details {
            font-size: 5.5pt;
            font-weight: 400;
            color: #222;
            line-height: 1.2;
        }

        @media print {
            body { 
                background: white; 
                margin: 0; 
                padding: 0; 
                display: flex;
                justify-content: center;
                align-items: flex-start;
            }
            .no-print { display: none !important; }
            .kta-card {
                box-shadow: none;
                margin-top: 5mm; 
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
    </style>
</head>
<body>

    <div class="no-print mb-6 flex gap-3 flex-wrap justify-center">
        <button onclick="downloadImage()" class="bg-green-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-green-700 flex items-center gap-2 shadow-lg transition-transform active:scale-95">
            <i data-lucide="download" class="w-5 h-5"></i> Download PNG
        </button>
        <button onclick="window.print()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700 flex items-center gap-2 shadow-lg transition-transform active:scale-95">
            <i data-lucide="printer" class="w-5 h-5"></i> Cetak / PDF
        </button>
        <button onclick="window.close()" class="bg-slate-200 text-slate-700 px-6 py-2 rounded-lg font-bold hover:bg-slate-300">
            Tutup
        </button>
    </div>

    <div class="kta-card" id="card">
        
        <img id="imgFoto" src="https://via.placeholder.com/150" class="photo-area" crossorigin="anonymous">
        
        <div class="text-area">
            <div id="txtKta" class="kta-number">LOADING...</div>
            <div id="txtNama" class="kta-name">LOADING...</div>
            <div class="kta-details">
                <div id="txtTtl">...</div>
                <div id="txtAlamat" style="margin-top: 1px;">...</div>
                <div id="txtHp" style="margin-top: 2px;">...</div>
            </div>
        </div>

    </div>

    <script>
        lucide.createIcons();

        async function loadData() {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');
            const nik = params.get('nik');

            if (!id && !nik) {
                alert("Data tidak ditemukan (ID/NIK kosong).");
                return;
            }

            try {
                const res = await fetch(`/api/get-kta?${id ? 'id='+id : 'nik='+nik}`);
                const data = await res.json();

                if (data.error) throw new Error(data.error);

                document.getElementById('txtKta').innerText = data.no_kta || "-";
                document.getElementById('txtNama').innerText = data.nama || "-";
                
                const tgl = data.tanggal_lahir || "";
                document.getElementById('txtTtl').innerText = `${data.tempat_lahir || 'CIANJUR'} / ${tgl}`;

                // FORMAT ALAMAT
                let baris1 = `${data.alamat || ''} RT.${data.rt}/${data.rw}, ${data.nama_desa}, ${data.nama_kecamatan}, KABUPATEN CIANJUR`.toUpperCase();
                
                if(baris1.length > 85) baris1 = baris1.substring(0, 82) + "...";

                document.getElementById('txtAlamat').innerHTML = `${baris1}<br>JAWA BARAT`;
                document.getElementById('txtHp').innerText = `Telp : ${data.no_hp_format || '-'}`;

                if (data.foto_orang_url) {
                    document.getElementById('imgFoto').src = data.foto_orang_url;
                } else if (data.foto_url) {
                    document.getElementById('imgFoto').src = data.foto_url; 
                }

            } catch (e) {
                alert("Gagal memuat data: " + e.message);
            }
        }

        // FUNGSI DOWNLOAD PNG (DIPERBAIKI)
        function downloadImage() {
            const card = document.getElementById('card');
            const namaFile = document.getElementById('txtNama').innerText || 'KTA_PERINDO';
            
            document.body.style.cursor = 'wait';

            // Pastikan font sudah terload sebelum screenshot
            document.fonts.ready.then(() => {
                html2canvas(card, {
                    scale: 5, // TINGKAT KETAJAMAN: 5x Resolusi Layar (Super HD)
                    useCORS: true,
                    backgroundColor: null,
                    
                    // TRIK: Memperbaiki CSS hanya saat proses cloning gambar
                    onclone: (clonedDoc) => {
                        const clonedNama = clonedDoc.getElementById('txtNama');
                        const clonedKta = clonedDoc.getElementById('txtKta');
                        
                        // 1. Paksa teks Nama agar tidak turun baris/terpotong
                        clonedNama.style.whiteSpace = 'nowrap';
                        clonedNama.style.overflow = 'visible'; // Biarkan melebar jika perlu
                        clonedNama.style.width = 'auto';       // Reset lebar paksa
                        clonedNama.style.letterSpacing = 'normal'; // Reset spacing biar aman
                        
                        // 2. Sesuaikan Font Smoothing agar lebih tebal di gambar
                        clonedNama.style.webkitFontSmoothing = 'none'; 
                        clonedKta.style.webkitFontSmoothing = 'none';
                    }
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `KTA_${namaFile.replace(/[^a-zA-Z0-9]/g, '_')}.png`;
                    link.href = canvas.toDataURL('image/png', 1.0); // Kualitas Maksimum
                    link.click();
                    document.body.style.cursor = 'default';
                }).catch(err => {
                    alert("Gagal membuat gambar: " + err);
                    document.body.style.cursor = 'default';
                });
            });
        }

        loadData();
    </script>
</body>
</html>
