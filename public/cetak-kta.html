<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cetak KTA Perindo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Font mirip dengan contoh KTP */
        @import url('https://fonts.googleapis.com/css2?family=Arimo:wght@400;700&display=swap');

        body {
            background-color: #e2e8f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            font-family: 'Arimo', sans-serif;
        }

        /* Ukuran Kartu ID-1 (KTP) : 85.60mm x 53.98mm */
        .kta-card {
            width: 85.6mm;
            height: 53.98mm;
            background-image: url('/kta_blanko.png'); /* Pastikan file ini ada di public folder */
            background-size: cover;
            background-position: center;
            position: relative;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            overflow: hidden;
            color: #333;
            /* Anti-aliasing text */
            -webkit-font-smoothing: antialiased;
        }

        /* Posisi Foto */
        .photo-area {
            position: absolute;
            top: 26.5mm;   /* Sesuaikan dengan kotak putih di blanko */
            left: 4.5mm;
            width: 15mm;
            height: 19mm;
            background-color: #ccc;
            object-fit: cover;
            border-radius: 1px;
        }

        /* Area Teks Utama */
        .text-area {
            position: absolute;
            top: 26mm;
            left: 21mm; /* Geser kanan dari foto */
            width: 45mm;
            line-height: 1.1;
        }

        .kta-number {
            font-size: 11pt;
            font-weight: 800;
            letter-spacing: 0.5px;
            margin-bottom: 1px;
            color: #000;
        }

        .kta-name {
            font-size: 9pt;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 2px;
            color: #000;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 45mm;
        }

        .kta-details {
            font-size: 5.5pt;
            color: #444;
            line-height: 1.2;
        }

        /* QR Code */
        .qr-area {
            position: absolute;
            top: 27mm;
            right: 4mm;
            width: 14mm;
            height: 14mm;
            background: white;
            padding: 1px;
        }
        .qr-area img {
            width: 100%;
            height: 100%;
        }

        /* CSS Print */
        @media print {
            body { 
                background: white; 
                margin: 0; 
                padding: 0; 
                display: block; 
            }
            .no-print { display: none !important; }
            .kta-card {
                box-shadow: none;
                /* Pastikan background tercetak */
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                margin: 5mm; /* Jarak aman tepi kertas */
            }
        }
    </style>
</head>
<body>

    <div class="no-print mb-6 flex gap-3">
        <button onclick="window.print()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700 flex items-center gap-2 shadow-lg">
            <i data-lucide="printer" class="w-5 h-5"></i> Cetak Kartu
        </button>
        <button onclick="window.close()" class="bg-slate-200 text-slate-700 px-6 py-2 rounded-lg font-bold hover:bg-slate-300">
            Tutup
        </button>
    </div>

    <div class="kta-card" id="card">
        <img id="imgFoto" src="https://via.placeholder.com/150" class="photo-area" crossorigin="anonymous">
        
        <div class="text-area">
            <div id="txtKta" class="kta-number">...</div>
            <div id="txtNama" class="kta-name">...</div>
            <div class="kta-details">
                <div id="txtTtl">...</div>
                <div id="txtAlamat" style="margin-top: 1px;">...</div>
                <div id="txtHp" style="margin-top: 2px;">Telp : ...</div>
            </div>
        </div>

        <div id="qrcode" class="qr-area"></div>
    </div>

    <script>
        lucide.createIcons();

        async function loadData() {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');
            const nik = params.get('nik');

            if (!id && !nik) {
                alert("Data tidak ditemukan");
                return;
            }

            try {
                // Panggil API Generator KTA
                const res = await fetch(`/api/get-kta?${id ? 'id='+id : 'nik='+nik}`);
                const data = await res.json();

                if (data.error) throw new Error(data.error);

                // Populate Data
                document.getElementById('txtKta').innerText = data.no_kta;
                document.getElementById('txtNama').innerText = data.nama;
                
                // Format TTL: CIANJUR / 26-12-1975
                const tgl = data.tanggal_lahir || ""; // Asumsi format DD-MM-YYYY dari input
                document.getElementById('txtTtl').innerText = `${data.tempat_lahir || 'CIANJUR'} / ${tgl}`;

                // Format Alamat: Kp Cikaret RT 003 RW 002
                // Desa, Kecamatan, Kab
                // Potong string agar muat jika terlalu panjang
                const alamatLengkap = `${data.alamat || ''} RT.${data.rt}/${data.rw}, ${data.nama_desa}, ${data.nama_kecamatan}, Jawa Barat`;
                document.getElementById('txtAlamat').innerText = alamatLengkap;

                document.getElementById('txtHp').innerText = `Telp : ${data.no_hp_format}`;

                // Foto (Gunakan Proxy atau CORS jika perlu, tapi Cloudinary biasanya aman)
                if (data.foto_orang_url) {
                    document.getElementById('imgFoto').src = data.foto_orang_url;
                } else if (data.foto_url) {
                    // Fallback ke foto KTP jika selfie tidak ada (opsional)
                    // document.getElementById('imgFoto').src = data.foto_url; 
                }

                // Generate QR Code (Isi: Nomor KTA atau Link Verifikasi)
                // Disini kita isi Nomor KTA dan Nama sebagai identitas
                const qrContent = `KTA:${data.no_kta}|NAMA:${data.nama}|NIK:${data.nik}`;
                new QRCode(document.getElementById("qrcode"), {
                    text: qrContent,
                    width: 128,
                    height: 128,
                    colorDark : "#000000",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.H
                });

            } catch (e) {
                alert("Gagal memuat data: " + e.message);
            }
        }

        loadData();
    </script>
</body>
</html>
