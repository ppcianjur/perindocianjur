<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cetak KTA Perindo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Font Arimo agar mirip dengan font asli KTP */
        @import url('https://fonts.googleapis.com/css2?family=Arimo:wght@400;700;800&display=swap');

        body {
            background-color: #e2e8f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            font-family: 'Arimo', sans-serif;
        }

        /* UKURAN KARTU (2 SISI VERTIKAL / ATAS-BAWAH) 
           Lebar Standar ID-1: 85.6mm
           Tinggi 1 Sisi: 53.98mm
           Tinggi Total (Depan + Belakang): 107.96mm
        */
        .kta-card {
            width: 85.6mm;
            height: 107.96mm; 
            /* Gambar blanko harus mencakup sisi depan (atas) dan belakang (bawah) */
            background-image: url('/kta_blanko.png');
            background-size: 100% 100%; 
            background-repeat: no-repeat;
            position: relative;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            overflow: hidden;
            color: #000;
            background-color: white;
            /* Memastikan warna akurat saat cetak */
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        /* --- POSISI DATA (HANYA DI SISI DEPAN / BAGIAN ATAS) --- */

        /* 1. Foto Anggota */
        .photo-area {
            position: absolute;
            top: 27mm;      /* Jarak dari tepi atas */
            left: 4.5mm;    /* Jarak dari tepi kiri */
            width: 15mm;
            height: 19mm;
            object-fit: cover;
            border-radius: 2px;
            z-index: 10;
            background-color: #ddd; /* Placeholder warna abu */
        }

        /* 2. Area Teks Data */
        .text-area {
            position: absolute;
            top: 26.5mm;
            left: 21mm; /* Tepat di sebelah kanan foto */
            width: 44mm; /* Lebar area teks dibatasi agar tidak menabrak area QR bawaan blanko */
            line-height: 1.15;
            z-index: 10;
        }

        .kta-number {
            font-size: 10pt;
            font-weight: 800;
            margin-bottom: 2px;
            letter-spacing: 0.5px;
        }

        .kta-name {
            font-size: 8pt;
            font-weight: 800;
            text-transform: uppercase;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .kta-details {
            font-size: 5.5pt;
            font-weight: 400;
            color: #222;
            line-height: 1.25;
        }

        /* CSS KHUSUS PRINT */
        @media print {
            body { 
                background: white; 
                margin: 0; 
                padding: 0; 
                display: flex;
                justify-content: center;
                align-items: flex-start;
            }
            .no-print { display: none !important; }
            .kta-card {
                box-shadow: none;
                margin-top: 10mm; /* Margin atas agar tidak terpotong printer */
                /* Memaksa background image tercetak */
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
    </style>
</head>
<body>

    <div class="no-print mb-6 flex gap-3">
        <button onclick="window.print()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700 flex items-center gap-2 shadow-lg">
            <i data-lucide="printer" class="w-5 h-5"></i> Cetak Kartu
        </button>
        <button onclick="window.close()" class="bg-slate-200 text-slate-700 px-6 py-2 rounded-lg font-bold hover:bg-slate-300">
            Tutup
        </button>
    </div>

    <div class="kta-card" id="card">
        
        <img id="imgFoto" src="https://via.placeholder.com/150" class="photo-area" crossorigin="anonymous">
        
        <div class="text-area">
            <div id="txtKta" class="kta-number">LOADING...</div>
            <div id="txtNama" class="kta-name">LOADING...</div>
            <div class="kta-details">
                <div id="txtTtl">...</div>
                <div id="txtAlamat" style="margin-top: 1px;">...</div>
                <div id="txtHp" style="margin-top: 2px;">...</div>
            </div>
        </div>

        </div>

    <script>
        lucide.createIcons();

        async function loadData() {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');
            const nik = params.get('nik');

            if (!id && !nik) {
                alert("Data tidak ditemukan (ID/NIK kosong).");
                return;
            }

            try {
                // Panggil API Backend
                const res = await fetch(`/api/get-kta?${id ? 'id='+id : 'nik='+nik}`);
                const data = await res.json();

                if (data.error) throw new Error(data.error);

                // Populate Data Teks
                document.getElementById('txtKta').innerText = data.no_kta || "-";
                document.getElementById('txtNama').innerText = data.nama || "-";
                
                const tgl = data.tanggal_lahir || "";
                document.getElementById('txtTtl').innerText = `${data.tempat_lahir || 'CIANJUR'} / ${tgl}`;

                // Format Alamat
                // Potong string agar muat di kotak kecil (Max sekitar 80 karakter)
                let alamatLengkap = `${data.alamat || ''} RT.${data.rt}/${data.rw}, ${data.nama_desa}, ${data.nama_kecamatan}, Jawa Barat`.toUpperCase();
                if(alamatLengkap.length > 85) alamatLengkap = alamatLengkap.substring(0, 82) + "...";
                
                document.getElementById('txtAlamat').innerText = alamatLengkap;
                document.getElementById('txtHp').innerText = `Telp : ${data.no_hp_format || '-'}`;

                // Populate Foto Profile
                if (data.foto_orang_url) {
                    document.getElementById('imgFoto').src = data.foto_orang_url;
                } else if (data.foto_url) {
                    // Fallback ke foto KTP jika selfie tidak ada
                    document.getElementById('imgFoto').src = data.foto_url; 
                }

            } catch (e) {
                alert("Gagal memuat data: " + e.message);
                console.error(e);
            }
        }

        loadData();
    </script>
</body>
</html>
