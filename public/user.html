<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Data Petugas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .bottom-nav-item.active { color: #2563eb; }
        .bottom-nav-item.active span { font-weight: bold; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* CSS CETAK A4 LANDSCAPE */
        @media print {
            @page { size: A4 landscape; margin: 5mm; }
            body { background: white; color: black; font-family: sans-serif; -webkit-print-color-adjust: exact; font-size: 10px; }
            header, nav, #sec-dashboard, #sec-scan, #sec-hasil, #sec-profil, .no-print { display: none !important; }
            #sec-laporan, #printArea { display: block !important; width: 100% !important; margin: 0 !important; }
            table { width: 100%; border-collapse: collapse; }
            th, td { border: 1px solid #000; padding: 4px; text-align: left; vertical-align: top; }
            th { background-color: #e5e7eb !important; font-weight: bold; text-align: center; }
            .print-header { text-align: center; margin-bottom: 10px; border-bottom: 2px solid black; }
        }
        #printArea { display: none; }
    </style>
</head>
<body class="bg-slate-50 pb-28 select-none">

    <header class="bg-blue-700 text-white pt-8 pb-10 px-6 rounded-b-[2.5rem] shadow-xl relative z-10">
        <div class="max-w-md mx-auto flex justify-between items-start">
            <div>
                <p class="text-blue-200 text-xs font-medium uppercase tracking-wider mb-1">Selamat Datang</p>
                <h1 class="text-2xl font-bold truncate w-48" id="userName">...</h1>
                <p class="text-xs text-blue-100 mt-1 opacity-80" id="userRole">Petugas Lapangan</p>
            </div>
        </div>
    </header>

    <main class="max-w-md mx-auto px-4 -mt-6 relative z-20">
        
        <section id="sec-dashboard" class="page-section space-y-4 animate-in fade-in slide-in-from-bottom-4 duration-500">
            <div class="bg-white p-6 rounded-3xl shadow-lg border border-slate-100">
                <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i data-lucide="bar-chart-3" class="w-5 h-5 text-blue-600"></i> Statistik Saya</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100"><p class="text-3xl font-extrabold text-blue-600" id="dashTotal">0</p><p class="text-xs text-blue-400 font-bold uppercase mt-1">Total Input</p></div>
                    <div class="bg-green-50 p-4 rounded-2xl border border-green-100"><p class="text-3xl font-extrabold text-green-600" id="dashToday">0</p><p class="text-xs text-green-400 font-bold uppercase mt-1">Hari Ini</p></div>
                </div>
            </div>
            <div class="bg-gradient-to-r from-orange-400 to-pink-500 p-6 rounded-3xl shadow-lg text-white relative overflow-hidden">
                <i data-lucide="scan-face" class="absolute -right-4 -bottom-4 w-32 h-32 text-white/10"></i>
                <h3 class="font-bold text-lg relative z-10">Mulai Scan Data?</h3>
                <p class="text-xs text-white/80 mb-4 relative z-10 max-w-[70%]">Fitur Scan KTP untuk mempercepat input data.</p>
                <button onclick="navTo('scan')" class="bg-white text-orange-500 px-6 py-2.5 rounded-xl font-bold text-sm shadow-md hover:scale-105 transition-transform relative z-10">Buka Scanner</button>
            </div>
        </section>

        <section id="sec-scan" class="page-section hidden space-y-4 animate-in fade-in duration-300">
            <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-200">
                <h3 class="font-bold text-slate-700 mb-3 text-sm flex items-center gap-2"><i data-lucide="credit-card" class="w-4 h-4 text-blue-500"></i> Foto KTP (Wajib)</h3>
                <div id="previewKtpContainer" class="hidden relative mb-3 group">
                    <img id="imgPreviewKtp" class="w-full h-48 object-cover rounded-xl shadow border-2 border-slate-100">
                    <button onclick="resetFoto('ktp')" class="absolute top-2 right-2 bg-red-500 text-white p-1.5 rounded-full shadow-lg"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>
                <div id="btnKtpPlaceholder" class="grid grid-cols-2 gap-3">
                    <button onclick="document.getElementById('inputKtpKamera').click()" class="py-3 bg-blue-50 text-blue-600 rounded-xl font-bold text-xs flex flex-col items-center gap-1 hover:bg-blue-100"><i data-lucide="camera" class="w-5 h-5"></i> Kamera</button>
                    <button onclick="document.getElementById('inputKtpGaleri').click()" class="py-3 bg-slate-50 text-slate-600 rounded-xl font-bold text-xs flex flex-col items-center gap-1 hover:bg-slate-100"><i data-lucide="image" class="w-5 h-5"></i> Galeri</button>
                </div>
                <input type="file" id="inputKtpKamera" accept="image/*" capture="environment" class="hidden" onchange="previewImage(this, 'ktp')">
                <input type="file" id="inputKtpGaleri" accept="image/*" class="hidden" onchange="previewImage(this, 'ktp')">
            </div>

            <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-200">
                <h3 class="font-bold text-slate-700 mb-3 text-sm flex items-center gap-2"><i data-lucide="user" class="w-4 h-4 text-green-500"></i> Foto Selfie (Opsional)</h3>
                <div id="previewOrangContainer" class="hidden relative mb-3 group">
                    <img id="imgPreviewOrang" class="w-full h-48 object-cover rounded-xl shadow border-2 border-slate-100">
                    <button onclick="resetFoto('orang')" class="absolute top-2 right-2 bg-red-500 text-white p-1.5 rounded-full shadow-lg"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>
                <div id="btnOrangPlaceholder" class="grid grid-cols-2 gap-3">
                    <button onclick="document.getElementById('inputOrangKamera').click()" class="py-3 bg-green-50 text-green-600 rounded-xl font-bold text-xs flex flex-col items-center gap-1 hover:bg-green-100"><i data-lucide="camera" class="w-5 h-5"></i> Kamera</button>
                    <button onclick="document.getElementById('inputOrangGaleri').click()" class="py-3 bg-slate-50 text-slate-600 rounded-xl font-bold text-xs flex flex-col items-center gap-1 hover:bg-slate-100"><i data-lucide="image" class="w-5 h-5"></i> Galeri</button>
                </div>
                <input type="file" id="inputOrangKamera" accept="image/*" capture="environment" class="hidden" onchange="previewImage(this, 'orang')">
                <input type="file" id="inputOrangGaleri" accept="image/*" class="hidden" onchange="previewImage(this, 'orang')">
            </div>

            <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-200">
                <h3 class="font-bold text-slate-700 mb-3 text-sm flex items-center gap-2"><i data-lucide="credit-card" class="w-4 h-4 text-red-500"></i> Foto KTA (Opsional)</h3>
                <div id="previewKtaContainer" class="hidden relative mb-3 group">
                    <img id="imgPreviewKta" class="w-full h-48 object-cover rounded-xl shadow border-2 border-slate-100">
                    <button onclick="resetFoto('kta')" class="absolute top-2 right-2 bg-red-500 text-white p-1.5 rounded-full shadow-lg"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>
                <div id="btnKtaPlaceholder" class="grid grid-cols-2 gap-3">
                    <button onclick="document.getElementById('inputKtaKamera').click()" class="py-3 bg-red-50 text-red-600 rounded-xl font-bold text-xs flex flex-col items-center gap-1 hover:bg-red-100"><i data-lucide="camera" class="w-5 h-5"></i> Kamera</button>
                    <button onclick="document.getElementById('inputKtaGaleri').click()" class="py-3 bg-slate-50 text-slate-600 rounded-xl font-bold text-xs flex flex-col items-center gap-1 hover:bg-slate-100"><i data-lucide="image" class="w-5 h-5"></i> Galeri</button>
                </div>
                <input type="file" id="inputKtaKamera" accept="image/*" capture="environment" class="hidden" onchange="previewImage(this, 'kta')">
                <input type="file" id="inputKtaGaleri" accept="image/*" class="hidden" onchange="previewImage(this, 'kta')">
            </div>

            <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-200 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">No. WhatsApp</label>
                        <input type="tel" id="noHp" class="w-full p-3 bg-slate-50 rounded-xl text-sm font-bold outline-none focus:ring-2 focus:ring-blue-500 border">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Jabatan</label>
                        <select id="jabatan" class="w-full p-3 bg-slate-50 rounded-xl text-sm font-bold outline-none focus:ring-2 focus:ring-blue-500 border">
                            <option value="">- Pilih -</option>
                            <option value="Ketua">Ketua DPRT</option>
                            <option value="Sekretaris">Sekretaris DPRT</option>
                            <option value="Bendahara">Bendahara DPRT</option>
                            <option value="Anggota">Anggota</option>
                            <option value="DPRT">DPRT</option>
                            <option value="Ketua DPC">Ketua DPC</option>
                            <option value="Sekretaris DPC">Sekretaris DPC</option>
                            <option value="Bendahara DPC">Bendahara DPC</option>
                        </select>
                    </div>
                </div>
                <button id="btnProses" onclick="prosesScan()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-2xl shadow-lg shadow-blue-200 hover:bg-blue-700 active:scale-95 transition-all flex items-center justify-center gap-2"><i data-lucide="scan-line"></i> Proses Data</button>
            </div>
        </section>

        <section id="sec-hasil" class="page-section hidden space-y-4 animate-in fade-in duration-300">
            <div class="flex justify-between items-center px-2 py-2">
                <h3 class="font-bold text-slate-700 text-lg">Data Tersimpan</h3>
                <div class="relative">
                    <input type="text" id="searchBox" placeholder="Cari nama..." class="pl-8 pr-3 py-2 rounded-full border border-slate-300 text-sm w-36 focus:w-48 transition-all outline-none shadow-sm" oninput="renderList()">
                    <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-2.5 top-2.5"></i>
                </div>
            </div>
            <div id="listContainer" class="space-y-3 min-h-[300px]"></div>
            <div id="pagination" class="flex justify-center items-center gap-2 pt-4 hidden">
                <button onclick="prevPage()" class="p-2 rounded-lg bg-white border border-slate-200 hover:bg-slate-50 disabled:opacity-50" id="btnPrev"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                <span id="pageInfo" class="text-xs font-bold text-slate-500">Hal 1</span>
                <button onclick="nextPage()" class="p-2 rounded-lg bg-white border border-slate-200 hover:bg-slate-50 disabled:opacity-50" id="btnNext"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
            </div>
        </section>

        <section id="sec-laporan" class="page-section hidden animate-in fade-in duration-300">
            <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm mb-6 no-print">
                <div class="flex items-center gap-4 mb-4">
                    <div class="w-12 h-12 bg-blue-50 rounded-full flex items-center justify-center"><i data-lucide="file-spreadsheet" class="w-6 h-6 text-blue-600"></i></div>
                    <div><h3 class="font-bold text-lg text-slate-800">Unduh Laporan</h3><p class="text-xs text-slate-500">Rekapitulasi data lengkap format A4</p></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="downloadExcel()" class="flex items-center justify-center gap-2 py-3 bg-green-600 text-white rounded-xl font-bold text-sm hover:bg-green-700 transition-all shadow-lg shadow-green-100"><i data-lucide="file-spreadsheet" class="w-4 h-4"></i> Excel Lengkap</button>
                    <button onclick="window.print()" class="flex items-center justify-center gap-2 py-3 bg-slate-800 text-white rounded-xl font-bold text-sm hover:bg-slate-900 transition-all shadow-lg shadow-slate-200"><i data-lucide="printer" class="w-4 h-4"></i> Print A4</button>
                </div>
            </div>
            <div id="printArea">
                <div class="print-header"><h1>LAPORAN DATA PENGURUS</h1><p id="printSubtitle">Dicetak oleh: ...</p></div>
                <table>
                    <thead>
                        <tr>
                            <th style="width: 3%">No</th><th style="width: 18%">Nama</th><th style="width: 10%">NIK</th><th style="width: 7%">JK</th>
                            <th style="width: 8%">Jabatan</th><th style="width: 10%">Kecamatan</th><th style="width: 10%">Desa</th>
                            <th style="width: 15%">Alamat</th><th style="width: 4%">RT</th><th style="width: 4%">RW</th><th style="width: 9%">No HP</th>
                        </tr>
                    </thead>
                    <tbody id="tableLaporanBody"></tbody>
                </table>
            </div>
        </section>

        <section id="sec-profil" class="page-section hidden animate-in fade-in duration-300">
            <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm space-y-6">
                <div class="text-center">
                    <div class="w-20 h-20 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-3 text-2xl font-bold"><i data-lucide="user" class="w-10 h-10"></i></div>
                    <h3 class="font-bold text-xl text-slate-800" id="profileName">...</h3>
                    <p class="text-sm text-slate-500 uppercase tracking-wide" id="profileRole">Petugas</p>
                </div>
                <div class="border-t pt-6">
                    <h4 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i data-lucide="lock" class="w-4 h-4"></i> Ganti Password</h4>
                    <div class="space-y-3">
                        <div><label class="block text-xs font-bold text-slate-400 uppercase mb-1">Password Lama</label><input type="password" id="oldPass" class="w-full p-3 bg-slate-50 border rounded-xl text-sm"></div>
                        <div><label class="block text-xs font-bold text-slate-400 uppercase mb-1">Password Baru</label><input type="password" id="newPass" class="w-full p-3 bg-slate-50 border rounded-xl text-sm"></div>
                        <button onclick="changePassword()" class="w-full py-3 bg-slate-800 text-white rounded-xl font-bold text-sm hover:bg-slate-900 transition-all">Simpan</button>
                    </div>
                </div>
                <button onclick="logout()" class="w-full py-3 border-2 border-red-100 text-red-500 rounded-xl font-bold text-sm hover:bg-red-50 transition-all flex items-center justify-center gap-2"><i data-lucide="log-out" class="w-4 h-4"></i> Keluar</button>
            </div>
        </section>
    </main>

    <nav class="fixed bottom-0 inset-x-0 bg-white border-t border-slate-200 pb-safe pt-2 px-2 shadow-[0_-5px_15px_rgba(0,0,0,0.05)] z-40 flex justify-between items-end">
        <button onclick="navTo('dashboard')" class="bottom-nav-item flex-1 flex flex-col items-center gap-1 p-2 pb-4 text-slate-400 hover:text-blue-600 transition-colors" data-target="dashboard"><i data-lucide="layout-dashboard" class="w-5 h-5"></i><span class="text-[9px] font-medium">Home</span></button>
        <button onclick="navTo('laporan')" class="bottom-nav-item flex-1 flex flex-col items-center gap-1 p-2 pb-4 text-slate-400 hover:text-blue-600 transition-colors" data-target="laporan"><i data-lucide="file-text" class="w-5 h-5"></i><span class="text-[9px] font-medium">Laporan</span></button>
        <button onclick="navTo('scan')" class="bottom-nav-item flex-1 flex flex-col items-center justify-end z-50 -mt-8" data-target="scan"><div class="bg-blue-600 w-14 h-14 rounded-full shadow-lg shadow-blue-200 border-4 border-slate-50 text-white flex items-center justify-center transform active:scale-90 transition-all"><i data-lucide="scan-line" class="w-7 h-7"></i></div><span class="text-[9px] font-bold text-blue-600 mt-1">SCAN</span></button>
        <button onclick="navTo('hasil')" class="bottom-nav-item flex-1 flex flex-col items-center gap-1 p-2 pb-4 text-slate-400 hover:text-blue-600 transition-colors" data-target="hasil"><i data-lucide="database" class="w-5 h-5"></i><span class="text-[9px] font-medium">Data</span></button>
        <button onclick="navTo('profil')" class="bottom-nav-item flex-1 flex flex-col items-center gap-1 p-2 pb-4 text-slate-400 hover:text-blue-600 transition-colors" data-target="profil"><i data-lucide="user-circle" class="w-5 h-5"></i><span class="text-[9px] font-medium">Profil</span></button>
    </nav>

    <div id="modalConfirm" class="fixed inset-0 z-50 hidden bg-slate-900/90 backdrop-blur-sm flex items-end sm:items-center justify-center p-0 sm:p-4 no-print">
        <div class="bg-white w-full max-w-lg rounded-t-[2rem] sm:rounded-3xl shadow-2xl flex flex-col h-[90vh] sm:h-[85vh] animate-in slide-in-from-bottom duration-300">
            <div class="bg-white p-5 border-b flex justify-between items-center rounded-t-[2rem]">
                <div>
                    <h3 class="font-bold text-xl text-slate-800" id="modalTitle">Konfirmasi Data</h3>
                    <p class="text-xs text-slate-400 mt-0.5">Cek kelengkapan data sebelum disimpan</p>
                </div>
                <button onclick="closeModal()" class="bg-slate-100 p-2.5 rounded-full hover:bg-slate-200 text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <div class="p-6 overflow-y-auto flex-1 bg-white space-y-6">
                <input type="hidden" id="editFotoUrl"><input type="hidden" id="editFotoOrangUrl"><input type="hidden" id="editFotoKtaUrl">
                <input type="hidden" id="editKodeKec"><input type="hidden" id="editKodeDesa">
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <p class="text-[10px] font-bold uppercase text-slate-400 tracking-wider">Foto KTP</p>
                        <div class="rounded-xl overflow-hidden border border-slate-200 bg-slate-50 aspect-video shadow-sm">
                            <img id="displayKtp" class="w-full h-full object-cover">
                        </div>
                    </div>
                    
                    <div class="space-y-2">
                        <p class="text-[10px] font-bold uppercase text-slate-400 tracking-wider">Foto Selfie</p>
                        <div class="relative group rounded-xl overflow-hidden border border-slate-200 bg-slate-50 aspect-video shadow-sm">
                            <img id="displayOrang" class="w-full h-full object-cover">
                            <div id="overlayEditOrang" class="absolute inset-0 bg-black/60 flex flex-col items-center justify-center gap-2 opacity-0 group-hover:opacity-100 transition-all">
                                <button onclick="document.getElementById('editFileOrang').click()" class="bg-white text-xs px-3 py-1.5 rounded-lg font-bold hover:bg-slate-100">Ubah</button>
                                <button onclick="hapusFoto('orang')" class="bg-red-500 text-white text-xs px-3 py-1.5 rounded-lg font-bold hover:bg-red-600">Hapus</button>
                            </div>
                        </div>
                        <input type="file" id="editFileOrang" class="hidden" accept="image/*" onchange="uploadNewFoto(this, 'orang')">
                    </div>

                    <div class="space-y-2 col-span-2">
                        <p class="text-[10px] font-bold uppercase text-slate-400 tracking-wider">Foto KTA</p>
                        <div class="relative group rounded-xl overflow-hidden border border-slate-200 bg-slate-50 aspect-video shadow-sm">
                            <img id="displayKta" class="w-full h-full object-cover">
                            <div id="overlayEditKta" class="absolute inset-0 bg-black/60 flex flex-col items-center justify-center gap-2 opacity-0 group-hover:opacity-100 transition-all">
                                <button onclick="document.getElementById('editFileKta').click()" class="bg-white text-xs px-3 py-1.5 rounded-lg font-bold hover:bg-slate-100">Ubah</button>
                                <button onclick="hapusFoto('kta')" class="bg-red-500 text-white text-xs px-3 py-1.5 rounded-lg font-bold hover:bg-red-600">Hapus</button>
                            </div>
                        </div>
                        <input type="file" id="editFileKta" class="hidden" accept="image/*" onchange="uploadNewFoto(this, 'kta')">
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="pb-2 border-b border-slate-100 text-xs font-bold text-blue-600 uppercase tracking-widest">Identitas Utama</div>
                    <div class="space-y-1"><label class="block text-xs font-bold text-slate-500 uppercase">NIK (16 Digit)</label><input id="editNik" type="text" inputmode="numeric" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl font-mono font-bold text-slate-700 outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition-all"></div>
                    <div class="space-y-1"><label class="block text-xs font-bold text-slate-500 uppercase">Nama Lengkap</label><input id="editNama" type="text" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-slate-700 uppercase outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition-all"></div>
                    <div class="space-y-1">
                        <label class="block text-xs font-bold text-slate-500 uppercase">Jenis Kelamin</label>
                        <select id="editGender" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-slate-700 outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition-all">
                            <option value="">-- Pilih --</option><option value="LAKI-LAKI">LAKI-LAKI</option><option value="PEREMPUAN">PEREMPUAN</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1"><label class="block text-xs font-bold text-slate-500 uppercase">Agama</label><input id="editAgama" type="text" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-slate-700 outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition-all"></div>
                        <div class="space-y-1"><label class="block text-xs font-bold text-slate-500 uppercase">Pekerjaan</label><input id="editPekerjaan" type="text" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-slate-700 outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition-all"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1"><label class="block text-xs font-bold text-slate-500 uppercase">Tempat Lahir</label><input id="editTempatLahir" type="text" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-slate-700 outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition-all"></div>
                        <div class="space-y-1"><label class="block text-xs font-bold text-slate-500 uppercase">Tgl Lahir</label><input id="editTglLahir" type="text" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-slate-700 outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition-all"></div>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="pb-2 border-b border-slate-100 text-xs font-bold text-blue-600 uppercase tracking-widest">Alamat & Lokasi</div>
                    <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200 space-y-3">
                        <div class="flex items-center gap-2 text-yellow-800 text-xs font-bold uppercase mb-1"><i data-lucide="map-pin" class="w-3 h-3"></i> Wilayah Administrasi</div>
                        <div class="space-y-1">
                            <label class="block text-[10px] font-bold text-yellow-700 uppercase">Kecamatan</label>
                            <input id="displayKec" type="text" readonly class="w-full px-3 py-2 bg-yellow-100/50 border border-yellow-300 rounded-lg text-sm font-bold text-slate-700 outline-none cursor-not-allowed">
                        </div>
                        <div class="space-y-1">
                            <label class="block text-[10px] font-bold text-yellow-700 uppercase">Desa / Kelurahan</label>
                            <input id="displayDesa" type="text" readonly class="w-full px-3 py-2 bg-yellow-100/50 border border-yellow-300 rounded-lg text-sm font-bold text-slate-700 outline-none cursor-not-allowed">
                        </div>
                    </div>
                    <div class="space-y-1"><label class="block text-xs font-bold text-slate-500 uppercase">Alamat Jalan / Kp</label><textarea id="editAlamat" rows="2" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-slate-700 outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition-all"></textarea></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1"><label class="block text-xs font-bold text-slate-500 uppercase text-center">RT</label><input id="editRt" type="text" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-center font-bold text-slate-700 outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition-all"></div>
                        <div class="space-y-1"><label class="block text-xs font-bold text-slate-500 uppercase text-center">RW</label><input id="editRw" type="text" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-center font-bold text-slate-700 outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition-all"></div>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="pb-2 border-b border-slate-100 text-xs font-bold text-blue-600 uppercase tracking-widest">Kontak & Jabatan</div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1"><label class="block text-xs font-bold text-slate-500 uppercase">No. HP / WA</label><input id="editNoHp" type="tel" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-slate-700 outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition-all"></div>
                        <div class="space-y-1">
                            <label class="block text-xs font-bold text-slate-500 uppercase">Jabatan</label>
                            <select id="editJabatan" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-slate-700 outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition-all">
                                <option value="Ketua">Ketua</option><option value="Sekretaris">Sekretaris</option><option value="Bendahara">Bendahara</option><option value="Anggota">Anggota</option><option value="Koordinator">Kordes</option>
                                <option value="Ketua DPC">Ketua DPC</option><option value="Sekretaris DPC">Sekretaris DPC</option><option value="Bendahara DPC">Bendahara DPC</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-5 border-t bg-slate-50">
                <button id="btnSimpan" onclick="simpanFinal()" class="w-full py-4 bg-blue-600 text-white font-bold text-lg rounded-xl shadow-lg shadow-blue-200 hover:bg-blue-700 active:scale-[0.98] transition-all flex justify-center items-center gap-2">
                    <i data-lucide="save"></i> Simpan Data
                </button>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        const user = JSON.parse(localStorage.getItem('user'));
        if(!user) window.location.href = '/index.html';
        document.getElementById('userName').innerText = user.username;
        document.getElementById('profileName').innerText = user.username;
        document.getElementById('printSubtitle').innerText = `Dicetak oleh: ${user.username} | Tanggal: ${new Date().toLocaleDateString('id-ID')}`;

        let fileKtp = null, fileOrang = null, fileKta = null, base64Ktp = "";
        let listKecamatan = [], allData = [];
        let currentPage = 1, currentDetailId = null;
        const rowsPerPage = 10;

        fetchMasterData(); loadMyData(); navTo('dashboard'); 

        function navTo(targetId) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`sec-${targetId}`).classList.remove('hidden');
            document.querySelectorAll('.bottom-nav-item').forEach(el => { el.classList.remove('active', 'text-blue-600'); if(el.dataset.target === targetId) el.classList.add('active', 'text-blue-600'); });
            if(targetId === 'dashboard') loadStats();
            if(targetId === 'hasil' || targetId === 'laporan') loadMyData();
        }

        async function fetchMasterData() {
            try {
                const res = await fetch('/api/locations?type=kecamatan');
                listKecamatan = await res.json();
            } catch (e) {}
        }

        async function loadStats() { document.getElementById('dashTotal').innerText = allData.length || '0'; }

        // SCAN
        function previewImage(input, type) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                reader.onload = e => {
                    if (type === 'ktp') {
                        document.getElementById('imgPreviewKtp').src = e.target.result;
                        document.getElementById('previewKtpContainer').classList.remove('hidden');
                        document.getElementById('btnKtpPlaceholder').classList.add('hidden');
                        fileKtp = file; base64Ktp = e.target.result.split(',')[1];
                    } else if (type === 'orang') {
                        document.getElementById('imgPreviewOrang').src = e.target.result;
                        document.getElementById('previewOrangContainer').classList.remove('hidden');
                        document.getElementById('btnOrangPlaceholder').classList.add('hidden');
                        fileOrang = file;
                    } else if (type === 'kta') {
                        document.getElementById('imgPreviewKta').src = e.target.result;
                        document.getElementById('previewKtaContainer').classList.remove('hidden');
                        document.getElementById('btnKtaPlaceholder').classList.add('hidden');
                        fileKta = file;
                    }
                }
                reader.readAsDataURL(file);
            }
        }
        function resetFoto(type) {
            if (type === 'ktp') { 
                fileKtp = null; base64Ktp = ""; document.getElementById('previewKtpContainer').classList.add('hidden'); document.getElementById('btnKtpPlaceholder').classList.remove('hidden'); document.getElementById('inputKtpKamera').value = ""; 
            } else if (type === 'orang') { 
                fileOrang = null; document.getElementById('previewOrangContainer').classList.add('hidden'); document.getElementById('btnOrangPlaceholder').classList.remove('hidden'); document.getElementById('inputOrangKamera').value = ""; 
            } else if (type === 'kta') {
                fileKta = null; document.getElementById('previewKtaContainer').classList.add('hidden'); document.getElementById('btnKtaPlaceholder').classList.remove('hidden'); document.getElementById('inputKtaKamera').value = "";
            }
        }

        async function prosesScan() {
            if (!fileKtp) return Swal.fire("Wajib", "Foto KTP tidak boleh kosong!", "warning");
            const hp = document.getElementById('noHp').value;
            const jab = document.getElementById('jabatan').value;
            if (!hp || !jab) return Swal.fire("Wajib", "No HP dan Jabatan harus diisi!", "warning");

            const btn = document.getElementById('btnProses'); btn.disabled = true; btn.innerHTML = `ðŸŒ€ Memproses...`;

            try {
                let fotoOrangUrl = "";
                if (fileOrang) {
                    const fdOrang = new FormData(); fdOrang.append('file', fileOrang);
                    const resOrang = await fetch('/api/upload-simple', { method: 'POST', body: fdOrang });
                    const jsonOrang = await resOrang.json();
                    if(jsonOrang.success) fotoOrangUrl = jsonOrang.url;
                }

                let fotoKtaUrl = "";
                if (fileKta) {
                    const fdKta = new FormData(); fdKta.append('file', fileKta);
                    const resKta = await fetch('/api/upload-simple', { method: 'POST', body: fdKta });
                    const jsonKta = await resKta.json();
                    if(jsonKta.success) fotoKtaUrl = jsonKta.url;
                }

                const fdKtp = new FormData(); fdKtp.append('foto', fileKtp); fdKtp.append('base64', base64Ktp); fdKtp.append('creator', user.username);
                const resKtp = await fetch('/api/upload-ktp', { method: 'POST', body: fdKtp });
                const jsonKtp = await resKtp.json();
                if (!jsonKtp.success) throw new Error(jsonKtp.error);

                openDetailModal({
                    ...jsonKtp.data, 
                    foto_url: jsonKtp.foto_url, 
                    foto_orang_url: fotoOrangUrl, 
                    foto_kta: fotoKtaUrl,
                    no_hp: hp, 
                    jabatan: jab
                }, false);
            } catch (e) { Swal.fire("Error", e.message, "error"); } 
            finally { btn.disabled = false; btn.innerHTML = `<i data-lucide="scan-line"></i> Proses Data`; lucide.createIcons(); }
        }

        // MODAL LOGIC
        async function openDetailModal(data, isReadOnlyMode) {
            currentDetailId = data.id || null;
            document.getElementById('displayKtp').src = data.foto_url;
            document.getElementById('editFotoUrl').value = data.foto_url;
            
            // Set Foto Orang / KTA
            document.getElementById('displayOrang').src = data.foto_orang_url || "https://via.placeholder.com/150?text=No+Photo";
            document.getElementById('editFotoOrangUrl').value = data.foto_orang_url || "";
            document.getElementById('displayKta').src = data.foto_kta || "https://via.placeholder.com/150?text=No+Photo";
            document.getElementById('editFotoKtaUrl').value = data.foto_kta || "";

            // Tampilkan Overlay Edit Foto jika mode "View" (isReadOnlyMode = true)
            // Namun Sembunyikan jika mode "Confirm" (isReadOnlyMode = false) karena di confirm ada tombol sendiri
            const overlayOrang = document.getElementById('overlayEditOrang');
            const overlayKta = document.getElementById('overlayEditKta');
            
            if (isReadOnlyMode) { 
                overlayOrang.classList.remove('hidden'); overlayOrang.classList.add('flex');
                overlayKta.classList.remove('hidden'); overlayKta.classList.add('flex');
            } else { 
                overlayOrang.classList.add('hidden'); overlayOrang.classList.remove('flex');
                overlayKta.classList.add('hidden'); overlayKta.classList.remove('flex');
            }

            // Fill Forms
            document.getElementById('editNik').value = data.nik || "";
            document.getElementById('editNama').value = data.nama || "";
            document.getElementById('editTempatLahir').value = data.tempat_lahir || "";
            document.getElementById('editTglLahir').value = data.tanggal_lahir || "";
            document.getElementById('editGender').value = data.jenis_kelamin ? data.jenis_kelamin.toUpperCase() : "";
            document.getElementById('editAgama').value = data.agama || "";
            document.getElementById('editPekerjaan').value = data.pekerjaan || "";
            document.getElementById('editAlamat').value = data.alamat || "";
            document.getElementById('editRt').value = data.rt || "";
            document.getElementById('editRw').value = data.rw || "";
            document.getElementById('editNoHp').value = data.no_hp || "";
            document.getElementById('editJabatan').value = data.jabatan || "Anggota";

            // Handle Lokasi (Tampilkan Nama saja di Input Readonly)
            let namaKec = data.kecamatan || "";
            let namaDesa = data.kelurahan || "";
            
            // Jika data dari DB (View History) biasanya ada field nama_kecamatan / nama_desa
            if(data.nama_kecamatan) namaKec = data.nama_kecamatan;
            if(data.nama_desa) namaDesa = data.nama_desa;

            document.getElementById('displayKec').value = namaKec;
            document.getElementById('displayDesa').value = namaDesa;
            
            // Simpan Code di Hidden Input untuk kebutuhan Save (terutama mode Scan)
            // Jika mode Scan, data.kode_desa sudah ada. Jika mode Edit, ambil dari existing.
            document.getElementById('editKodeDesa').value = data.kode_desa_lengkap || data.kode_desa || "";
            
            // Logic ReadOnly Inputs
            const inputs = document.querySelectorAll('#modalConfirm input:not([type="file"]), #modalConfirm select, #modalConfirm textarea');
            inputs.forEach(el => el.disabled = isReadOnlyMode);
            
            // Tombol Simpan
            const btnSimpan = document.getElementById('btnSimpan');
            if (isReadOnlyMode) {
                btnSimpan.classList.add('hidden');
                document.getElementById('modalTitle').innerText = "Detail Data";
            } else {
                btnSimpan.classList.remove('hidden');
                document.getElementById('modalTitle').innerText = "Konfirmasi Data";
                // Jika baru scan, coba auto-match kode desa jika belum ada
                if(!data.kode_desa_lengkap) await autoMatchLocation(data);
            }
            document.getElementById('modalConfirm').classList.remove('hidden');
        }

        async function autoMatchLocation(data) {
             const textKec = (data.kecamatan || "").toLowerCase().replace("kecamatan", "").trim();
             const matchKec = listKecamatan.find(k => k.nama_kecamatan.toLowerCase().includes(textKec));
             
             if(matchKec) {
                 // Set Nama Kecamatan di Display
                 document.getElementById('displayKec').value = matchKec.nama_kecamatan;
                 
                 // Cari Desa
                 try {
                     const res = await fetch(`/api/locations?type=desa&parent=${matchKec.kode_kec}`);
                     const desas = await res.json();
                     const textDesa = (data.kelurahan || "").toLowerCase().replace(/(desa|kelurahan)/g,"").trim();
                     const matchDesa = desas.find(d => d.nama_desa.toLowerCase().includes(textDesa));
                     
                     if(matchDesa) {
                         document.getElementById('displayDesa').value = matchDesa.nama_desa;
                         document.getElementById('editKodeDesa').value = matchDesa.kode_desa_lengkap;
                     }
                 } catch(e) {}
             }
        }

        async function uploadNewFoto(input, type) { 
            if (!input.files || !input.files[0]) return;
            const loading = Swal.fire({title: 'Update Foto...', didOpen: () => Swal.showLoading()});
            try {
                const fd = new FormData(); fd.append('file', input.files[0]);
                const res = await fetch('/api/upload-simple', { method: 'POST', body: fd });
                const json = await res.json();
                if (json.success) {
                    await fetch('/api/update-foto-orang', { 
                        method: 'POST', 
                        headers: {'Content-Type': 'application/json'}, 
                        body: JSON.stringify({ id: currentDetailId, foto_url: json.url, type: type }) 
                    });
                    
                    if(type === 'orang') document.getElementById('displayOrang').src = json.url;
                    else if(type === 'kta') document.getElementById('displayKta').src = json.url;

                    loadMyData(); loading.close(); Swal.fire("Sukses", "Foto diubah", "success");
                }
            } catch (e) { loading.close(); Swal.fire("Gagal", e.message, "error"); }
        }
        
        async function hapusFoto(type) {
            if(!confirm("Hapus foto ini?")) return;
            await fetch('/api/update-foto-orang', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({ id: currentDetailId, foto_url: "", type: type }) 
            });
            
            if(type === 'orang') document.getElementById('displayOrang').src = "https://via.placeholder.com/150?text=No+Photo";
            else if(type === 'kta') document.getElementById('displayKta').src = "https://via.placeholder.com/150?text=No+Photo";
            
            loadMyData();
        }

        async function simpanFinal() {
            const payload = {
                nik: document.getElementById('editNik').value,
                nama: document.getElementById('editNama').value,
                jenis_kelamin: document.getElementById('editGender').value,
                kode_desa_lengkap: document.getElementById('editKodeDesa').value, // Ambil dari Hidden
                nama_desa: document.getElementById('displayDesa').value, // Ambil text display
                foto_url: document.getElementById('editFotoUrl').value,
                foto_orang_url: document.getElementById('editFotoOrangUrl').value,
                foto_kta: document.getElementById('editFotoKtaUrl').value,
                agama: document.getElementById('editAgama').value,
                pekerjaan: document.getElementById('editPekerjaan').value,
                no_hp: document.getElementById('editNoHp').value,
                jabatan: document.getElementById('editJabatan').value,
                tempat_lahir: document.getElementById('editTempatLahir').value,
                tanggal_lahir: document.getElementById('editTglLahir').value,
                alamat: document.getElementById('editAlamat').value,
                rt: document.getElementById('editRt').value, 
                rw: document.getElementById('editRw').value,
                creator: user.username
            };
            try {
                const res = await fetch('/api/simpan-data', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)});
                const result = await res.json();
                if(result.success) { closeModal(); Swal.fire("Berhasil", "Data disimpan", "success"); navTo('hasil'); } else throw new Error(result.error);
            } catch(e) { Swal.fire("Gagal", e.message, "error"); }
        }

        function closeModal() { document.getElementById('modalConfirm').classList.add('hidden'); }

        async function loadMyData() {
            if(allData.length === 0) document.getElementById('listContainer').innerHTML = '<div class="text-center py-10"><span class="animate-spin">ðŸŒ€</span></div>';
            try {
                const res = await fetch(`/api/my-data?user=${user.username}`);
                allData = await res.json();
                document.getElementById('dashTotal').innerText = allData.length;
                renderList(); renderTableLaporan();
            } catch (e) {}
        }

        function renderList() {
            const container = document.getElementById('listContainer');
            const search = document.getElementById('searchBox').value.toLowerCase();
            const filtered = allData.filter(i => i.nama.toLowerCase().includes(search));
            container.innerHTML = "";
            const start = (currentPage - 1) * rowsPerPage;
            const paginated = filtered.slice(start, start + rowsPerPage);
            if (paginated.length === 0) { container.innerHTML = '<p class="text-center text-slate-400 py-10">Data tidak ditemukan</p>'; return; }
            paginated.forEach(item => {
                const kec = item.nama_kecamatan || 'Kecamatan'; 
                container.innerHTML += `<div onclick='openDetailFromList(${JSON.stringify(item)})' class="bg-white p-3 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-3 active:scale-95 transition-transform cursor-pointer"><img src="${item.foto_url}" class="w-12 h-12 rounded-lg object-cover bg-slate-100"><div class="flex-1 min-w-0"><p class="font-bold text-slate-800 text-sm truncate">${item.nama}</p><div class="flex items-center gap-2 text-[10px] text-slate-500 mt-0.5"><span class="bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded font-bold">${item.jabatan}</span><span class="truncate">${item.nama_desa || 'Desa'} - ${kec}</span></div></div><i data-lucide="chevron-right" class="w-4 h-4 text-slate-300"></i></div>`;
            });
            document.getElementById('pageInfo').innerText = `Hal ${currentPage}`;
            if(allData.length > rowsPerPage) document.getElementById('pagination').classList.remove('hidden');
            lucide.createIcons();
        }

        function renderTableLaporan() {
            const body = document.getElementById('tableLaporanBody'); body.innerHTML = '';
            allData.forEach((item, index) => {
                body.innerHTML += `<tr><td>${index+1}</td><td>${item.nama}</td><td style="font-family: monospace;">${item.nik}</td><td>${item.jenis_kelamin || '-'}</td><td>${item.jabatan}</td><td>${item.nama_kecamatan || '-'}</td><td>${item.nama_desa || '-'}</td><td>${item.alamat || '-'}</td><td>${item.rt || '-'}</td><td>${item.rw || '-'}</td><td>${item.no_hp}</td></tr>`;
            });
        }

        function downloadExcel() {
            if (allData.length === 0) return Swal.fire("Kosong", "Tidak ada data untuk diexport", "info");
            const dataToExport = allData.map((item, idx) => ({
                "No": idx + 1, "Nama Lengkap": item.nama, "NIK": item.nik, "Jenis Kelamin": item.jenis_kelamin || "-", "Jabatan": item.jabatan, "Kecamatan": item.nama_kecamatan || "-", "Desa": item.nama_desa, "Alamat Lengkap": item.alamat, "RT": item.rt || "-", "RW": item.rw || "-", "No HP": item.no_hp, "Tempat Lahir": item.tempat_lahir, "Tanggal Lahir": item.tanggal_lahir, "Waktu Input": item.created_at
            }));
            const ws = XLSX.utils.json_to_sheet(dataToExport); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Data Pengurus"); XLSX.writeFile(wb, `Laporan_Pengurus_${user.username}.xlsx`);
        }

        async function changePassword() {
            const oldP = document.getElementById('oldPass').value; const newP = document.getElementById('newPass').value;
            if(!oldP || !newP) return Swal.fire("Error", "Isi semua form password!", "warning");
            try {
                const res = await fetch('/api/user/change-password', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ username: user.username, oldPassword: oldP, newPassword: newP }) });
                const json = await res.json();
                if(json.success) { Swal.fire("Sukses", "Password berhasil diganti. Silakan login ulang.", "success").then(logout); } else throw new Error(json.error);
            } catch(e) { Swal.fire("Gagal", e.message, "error"); }
        }

        function openDetailFromList(item) { openDetailModal(item, true); }
        function nextPage() { currentPage++; renderList(); }
        function prevPage() { if (currentPage > 1) { currentPage--; renderList(); } }
        function logout() { localStorage.clear(); window.location.href='/index.html'; }
    </script>
</body>
</html>
