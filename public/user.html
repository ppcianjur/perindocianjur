<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Data Petugas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .bottom-nav-item.active { color: #2563eb; }
        .bottom-nav-item.active span { font-weight: bold; }
        /* Hide scrollbar for clean UI */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-50 pb-28 select-none">

    <header class="bg-blue-700 text-white pt-8 pb-10 px-6 rounded-b-[2.5rem] shadow-xl relative z-10">
        <div class="max-w-md mx-auto flex justify-between items-start">
            <div>
                <p class="text-blue-200 text-xs font-medium uppercase tracking-wider mb-1">Selamat Datang</p>
                <h1 class="text-2xl font-bold truncate w-48" id="userName">...</h1>
                <p class="text-xs text-blue-100 mt-1 opacity-80" id="userRole">Petugas Lapangan</p>
            </div>
            <button onclick="logout()" class="p-3 bg-white/10 hover:bg-white/20 rounded-2xl transition-all backdrop-blur-sm">
                <i data-lucide="log-out" class="w-5 h-5 text-white"></i>
            </button>
        </div>
    </header>

    <main class="max-w-md mx-auto px-4 -mt-6 relative z-20">
        
        <section id="sec-dashboard" class="page-section space-y-4 animate-in fade-in slide-in-from-bottom-4 duration-500">
            <div class="bg-white p-6 rounded-3xl shadow-lg border border-slate-100">
                <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2">
                    <i data-lucide="bar-chart-3" class="w-5 h-5 text-blue-600"></i> Statistik Saya
                </h3>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100">
                        <p class="text-3xl font-extrabold text-blue-600" id="dashTotal">0</p>
                        <p class="text-xs text-blue-400 font-bold uppercase mt-1">Total Input</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-2xl border border-green-100">
                        <p class="text-3xl font-extrabold text-green-600" id="dashToday">0</p>
                        <p class="text-xs text-green-400 font-bold uppercase mt-1">Hari Ini</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-gradient-to-r from-orange-400 to-pink-500 p-6 rounded-3xl shadow-lg text-white relative overflow-hidden">
                <i data-lucide="scan-face" class="absolute -right-4 -bottom-4 w-32 h-32 text-white/10"></i>
                <h3 class="font-bold text-lg relative z-10">Mulai Scan Data?</h3>
                <p class="text-xs text-white/80 mb-4 relative z-10 max-w-[70%]">Gunakan fitur Scan KTP untuk mempercepat input data pengurus.</p>
                <button onclick="navTo('scan')" class="bg-white text-orange-500 px-6 py-2.5 rounded-xl font-bold text-sm shadow-md hover:scale-105 transition-transform relative z-10">
                    Buka Scanner
                </button>
            </div>
        </section>

        <section id="sec-scan" class="page-section hidden space-y-4 animate-in fade-in duration-300">
            
            <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-200">
                <h3 class="font-bold text-slate-700 mb-3 text-sm flex items-center gap-2"><i data-lucide="credit-card" class="w-4 h-4 text-blue-500"></i> Foto KTP (Wajib)</h3>
                
                <div id="previewKtpContainer" class="hidden relative mb-3 group">
                    <img id="imgPreviewKtp" class="w-full h-48 object-cover rounded-xl shadow border-2 border-slate-100">
                    <button onclick="resetFoto('ktp')" class="absolute top-2 right-2 bg-red-500 text-white p-1.5 rounded-full shadow-lg"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>

                <div id="btnKtpPlaceholder" class="grid grid-cols-2 gap-3">
                    <button onclick="document.getElementById('inputKtpKamera').click()" class="py-3 bg-blue-50 text-blue-600 rounded-xl font-bold text-xs flex flex-col items-center gap-1 hover:bg-blue-100"><i data-lucide="camera" class="w-5 h-5"></i> Kamera</button>
                    <button onclick="document.getElementById('inputKtpGaleri').click()" class="py-3 bg-slate-50 text-slate-600 rounded-xl font-bold text-xs flex flex-col items-center gap-1 hover:bg-slate-100"><i data-lucide="image" class="w-5 h-5"></i> Galeri</button>
                </div>
                <input type="file" id="inputKtpKamera" accept="image/*" capture="environment" class="hidden" onchange="previewImage(this, 'ktp')">
                <input type="file" id="inputKtpGaleri" accept="image/*" class="hidden" onchange="previewImage(this, 'ktp')">
            </div>

            <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-200">
                <h3 class="font-bold text-slate-700 mb-3 text-sm flex items-center gap-2">
                    <i data-lucide="user" class="w-4 h-4 text-green-500"></i> Foto Orang (Opsional)
                </h3>
                
                <div id="previewOrangContainer" class="hidden relative mb-3 group">
                    <img id="imgPreviewOrang" class="w-full h-48 object-cover rounded-xl shadow border-2 border-slate-100">
                    <button onclick="resetFoto('orang')" class="absolute top-2 right-2 bg-red-500 text-white p-1.5 rounded-full shadow-lg"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>

                <div id="btnOrangPlaceholder" class="grid grid-cols-2 gap-3">
                    <button onclick="document.getElementById('inputOrangKamera').click()" class="py-3 bg-green-50 text-green-600 rounded-xl font-bold text-xs flex flex-col items-center gap-1 hover:bg-green-100"><i data-lucide="camera" class="w-5 h-5"></i> Kamera</button>
                    <button onclick="document.getElementById('inputOrangGaleri').click()" class="py-3 bg-slate-50 text-slate-600 rounded-xl font-bold text-xs flex flex-col items-center gap-1 hover:bg-slate-100"><i data-lucide="image" class="w-5 h-5"></i> Galeri</button>
                </div>
                <input type="file" id="inputOrangKamera" accept="image/*" capture="environment" class="hidden" onchange="previewImage(this, 'orang')">
                <input type="file" id="inputOrangGaleri" accept="image/*" class="hidden" onchange="previewImage(this, 'orang')">
            </div>

            <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-200 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">No. WhatsApp</label>
                        <input type="tel" id="noHp" class="w-full p-3 bg-slate-50 rounded-xl text-sm font-bold outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Jabatan</label>
                        <select id="jabatan" class="w-full p-3 bg-slate-50 rounded-xl text-sm font-bold outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">- Pilih -</option>
                            <option value="Ketua">Ketua</option>
                            <option value="Sekretaris">Sekretaris</option>
                            <option value="Bendahara">Bendahara</option>
                            <option value="Anggota">Anggota</option>
                            <option value="Koordinator">Kordes</option>
                        </select>
                    </div>
                </div>
                <button id="btnProses" onclick="prosesScan()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-2xl shadow-lg shadow-blue-200 hover:bg-blue-700 active:scale-95 transition-all flex items-center justify-center gap-2">
                    <i data-lucide="scan-line"></i> Proses Data
                </button>
            </div>
        </section>

        <section id="sec-hasil" class="page-section hidden space-y-4 animate-in fade-in duration-300">
            <div class="flex justify-between items-center px-1">
                <h3 class="font-bold text-slate-700">Data Tersimpan</h3>
                <input type="text" id="searchBox" placeholder="Cari nama..." class="px-3 py-1.5 rounded-full border border-slate-200 text-xs w-32 focus:w-48 transition-all outline-none" onkeyup="filterData()">
            </div>
            
            <div id="listContainer" class="space-y-3 min-h-[300px]"></div>
            
            <div id="pagination" class="flex justify-center items-center gap-2 pt-4 hidden">
                <button onclick="prevPage()" class="p-2 rounded-lg bg-white border border-slate-200 hover:bg-slate-50 disabled:opacity-50" id="btnPrev"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                <span id="pageInfo" class="text-xs font-bold text-slate-500">Hal 1</span>
                <button onclick="nextPage()" class="p-2 rounded-lg bg-white border border-slate-200 hover:bg-slate-50 disabled:opacity-50" id="btnNext"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
            </div>
        </section>

        <section id="sec-laporan" class="page-section hidden animate-in fade-in duration-300">
            <div class="bg-white p-8 rounded-3xl text-center border border-slate-200">
                <div class="w-20 h-20 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="file-spreadsheet" class="w-10 h-10 text-blue-600"></i>
                </div>
                <h3 class="font-bold text-lg text-slate-800">Laporan Data</h3>
                <p class="text-sm text-slate-500 mb-6">Fitur unduh laporan dalam format Excel/PDF akan segera tersedia.</p>
                <button class="px-6 py-2 bg-slate-100 text-slate-400 font-bold rounded-xl text-sm cursor-not-allowed">Download Report</button>
            </div>
        </section>

    </main>

    <nav class="fixed bottom-0 inset-x-0 bg-white border-t border-slate-200 pb-safe pt-2 px-6 shadow-[0_-5px_15px_rgba(0,0,0,0.05)] z-40 flex justify-between items-center">
        <button onclick="navTo('dashboard')" class="bottom-nav-item active flex flex-col items-center gap-1 p-2 text-slate-400 hover:text-blue-600 transition-colors" data-target="dashboard">
            <i data-lucide="layout-dashboard" class="w-6 h-6"></i>
            <span class="text-[10px] font-medium">Dashboard</span>
        </button>
        <button onclick="navTo('scan')" class="bottom-nav-item flex flex-col items-center gap-1 p-2 text-slate-400 hover:text-blue-600 transition-colors" data-target="scan">
            <div class="bg-blue-600 p-3 rounded-full -mt-8 shadow-lg shadow-blue-200 border-4 border-slate-50 text-white">
                <i data-lucide="scan-line" class="w-6 h-6"></i>
            </div>
            <span class="text-[10px] font-medium text-blue-600">Scan</span>
        </button>
        <button onclick="navTo('hasil')" class="bottom-nav-item flex flex-col items-center gap-1 p-2 text-slate-400 hover:text-blue-600 transition-colors" data-target="hasil">
            <i data-lucide="database" class="w-6 h-6"></i>
            <span class="text-[10px] font-medium">Data Saya</span>
        </button>
        <button onclick="navTo('laporan')" class="bottom-nav-item flex flex-col items-center gap-1 p-2 text-slate-400 hover:text-blue-600 transition-colors" data-target="laporan">
            <i data-lucide="file-text" class="w-6 h-6"></i>
            <span class="text-[10px] font-medium">Laporan</span>
        </button>
    </nav>

    <div id="modalConfirm" class="fixed inset-0 z-50 hidden bg-slate-900/90 backdrop-blur-sm flex items-end sm:items-center justify-center p-0 sm:p-4">
        <div class="bg-white w-full max-w-lg rounded-t-[2rem] sm:rounded-3xl shadow-2xl flex flex-col h-[90vh] sm:h-[85vh] animate-in slide-in-from-bottom duration-300">
            <div class="bg-white p-4 border-b flex justify-between items-center rounded-t-[2rem]">
                <h3 class="font-bold text-lg" id="modalTitle">Konfirmasi Data</h3>
                <button onclick="closeModal()" class="bg-slate-100 p-2 rounded-full hover:bg-slate-200"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <div class="p-6 overflow-y-auto flex-1 bg-slate-50 space-y-4">
                <input type="hidden" id="editFotoUrl">
                <input type="hidden" id="editFotoOrangUrl">
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <p class="text-[10px] font-bold uppercase text-slate-400">Foto KTP</p>
                        <img id="displayKtp" class="w-full h-32 object-cover rounded-xl border border-slate-200 bg-white">
                    </div>
                    <div class="space-y-2 relative">
                        <p class="text-[10px] font-bold uppercase text-slate-400">Foto Orang</p>
                        <div class="relative group">
                            <img id="displayOrang" src="https://via.placeholder.com/150?text=No+Photo" class="w-full h-32 object-cover rounded-xl border border-slate-200 bg-white">
                            
                            <div id="overlayEditFoto" class="absolute inset-0 bg-black/50 rounded-xl hidden flex-col items-center justify-center gap-2 opacity-0 group-hover:opacity-100 transition-all">
                                <button onclick="document.getElementById('editFileOrang').click()" class="bg-white text-xs px-3 py-1 rounded-full font-bold">Ubah</button>
                                <button onclick="hapusFotoOrang()" class="bg-red-500 text-white text-xs px-3 py-1 rounded-full font-bold">Hapus</button>
                            </div>
                        </div>
                        <input type="file" id="editFileOrang" class="hidden" accept="image/*" onchange="uploadNewFotoOrang(this)">
                    </div>
                </div>

                <div class="space-y-3">
                    <div>
                        <label class="label-xs">NIK</label>
                        <input id="editNik" type="text" inputmode="numeric" class="input-field font-mono">
                    </div>
                    <div>
                        <label class="label-xs">Nama Lengkap</label>
                        <input id="editNama" type="text" class="input-field font-bold uppercase">
                    </div>
                    
                    <div class="bg-yellow-50 p-3 rounded-xl border border-yellow-200 space-y-2">
                         <label class="label-xs text-yellow-700">Kecamatan & Desa (Database)</label>
                         <select id="editKec" onchange="loadDesaOptions(this.value)" class="input-field bg-white mb-2"></select>
                         <select id="editDesa" class="input-field bg-white"></select>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="label-xs">Tempat Lahir</label>
                            <input id="editTempatLahir" type="text" class="input-field">
                        </div>
                        <div>
                            <label class="label-xs">Tgl Lahir</label>
                            <input id="editTglLahir" type="text" class="input-field">
                        </div>
                    </div>
                    
                    <div>
                        <label class="label-xs">Alamat</label>
                        <textarea id="editAlamat" rows="2" class="input-field"></textarea>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="label-xs">No. HP</label>
                            <input id="editNoHp" type="tel" class="input-field">
                        </div>
                        <div>
                            <label class="label-xs">Jabatan</label>
                            <select id="editJabatan" class="input-field">
                                <option value="Ketua">Ketua</option>
                                <option value="Sekretaris">Sekretaris</option>
                                <option value="Bendahara">Bendahara</option>
                                <option value="Anggota">Anggota</option>
                                <option value="Koordinator">Kordes</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-4 border-t bg-white">
                <button id="btnSimpan" onclick="simpanFinal()" class="w-full py-3.5 bg-blue-600 text-white font-bold rounded-xl shadow-lg hover:bg-blue-700 active:scale-95 transition-all">
                    Simpan Data
                </button>
            </div>
        </div>
    </div>

    <style>
        .label-xs { display: block; font-size: 10px; font-weight: 800; text-transform: uppercase; color: #64748b; margin-bottom: 4px; }
        .input-field { width: 100%; padding: 10px; background-color: #fff; border: 1px solid #e2e8f0; border-radius: 0.75rem; font-size: 14px; outline: none; transition: all; }
        .input-field:focus { ring: 2px; ring-color: #3b82f6; border-color: #3b82f6; }
        .input-field:read-only { background-color: #f1f5f9; color: #94a3b8; cursor: default; }
    </style>

    <script>
        lucide.createIcons();
        const user = JSON.parse(localStorage.getItem('user'));
        if(!user) window.location.href = '/index.html';
        document.getElementById('userName').innerText = user.username;

        // --- STATE VARIABLES ---
        let fileKtp = null;
        let fileOrang = null;
        let base64Ktp = "";
        let listKecamatan = [];
        
        let allData = [];
        let currentPage = 1;
        const rowsPerPage = 10;
        let currentDetailId = null; // ID data yang sedang dilihat detilnya

        // --- INIT ---
        fetchMasterData();
        loadMyData();

        // --- NAVIGATION LOGIC ---
        function navTo(targetId) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`sec-${targetId}`).classList.remove('hidden');
            
            document.querySelectorAll('.bottom-nav-item').forEach(el => el.classList.remove('active', 'text-blue-600'));
            document.querySelector(`[data-target="${targetId}"]`).classList.add('active', 'text-blue-600');
            
            if(targetId === 'dashboard') loadStats();
            if(targetId === 'hasil') loadMyData();
        }

        async function fetchMasterData() {
            try {
                const res = await fetch('/api/locations?type=kecamatan');
                listKecamatan = await res.json();
                const selKec = document.getElementById('editKec');
                selKec.innerHTML = '<option value="">- Pilih Kecamatan -</option>';
                listKecamatan.forEach(k => selKec.innerHTML += `<option value="${k.kode_kec}">${k.nama_kecamatan}</option>`);
            } catch (e) { console.error(e); }
        }

        async function loadStats() {
            // Sederhana: hitung dari allData jika sudah load, atau fetch count khusus
            document.getElementById('dashTotal').innerText = allData.length || '-';
            // Logic hari ini bisa difilter dari created_at
        }

        // --- 1. HANDLING INPUT FOTO ---
        function previewImage(input, type) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                reader.onload = e => {
                    if (type === 'ktp') {
                        document.getElementById('imgPreviewKtp').src = e.target.result;
                        document.getElementById('previewKtpContainer').classList.remove('hidden');
                        document.getElementById('btnKtpPlaceholder').classList.add('hidden');
                        fileKtp = file;
                        base64Ktp = e.target.result.split(',')[1];
                    } else {
                        document.getElementById('imgPreviewOrang').src = e.target.result;
                        document.getElementById('previewOrangContainer').classList.remove('hidden');
                        document.getElementById('btnOrangPlaceholder').classList.add('hidden');
                        fileOrang = file;
                    }
                }
                reader.readAsDataURL(file);
            }
        }
        
        function resetFoto(type) {
            if (type === 'ktp') {
                fileKtp = null; base64Ktp = "";
                document.getElementById('previewKtpContainer').classList.add('hidden');
                document.getElementById('btnKtpPlaceholder').classList.remove('hidden');
                document.getElementById('inputKtpKamera').value = "";
            } else {
                fileOrang = null;
                document.getElementById('previewOrangContainer').classList.add('hidden');
                document.getElementById('btnOrangPlaceholder').classList.remove('hidden');
                document.getElementById('inputOrangKamera').value = "";
            }
        }

        // --- 2. PROSES SCAN & UPLOAD ---
        async function prosesScan() {
            if (!fileKtp) return Swal.fire("Wajib", "Foto KTP tidak boleh kosong!", "warning");
            const hp = document.getElementById('noHp').value;
            const jab = document.getElementById('jabatan').value;
            if (!hp || !jab) return Swal.fire("Wajib", "No HP dan Jabatan harus diisi!", "warning");

            const btn = document.getElementById('btnProses');
            btn.disabled = true;
            btn.innerHTML = `ðŸŒ€ Memproses...`;

            try {
                // Upload Foto Orang dulu (jika ada) karena tidak butuh OCR
                let fotoOrangUrl = "";
                if (fileOrang) {
                    const fdOrang = new FormData();
                    fdOrang.append('file', fileOrang);
                    const resOrang = await fetch('/api/upload-simple', { method: 'POST', body: fdOrang });
                    const jsonOrang = await resOrang.json();
                    if(jsonOrang.success) fotoOrangUrl = jsonOrang.url;
                }

                // Upload KTP & OCR
                const fdKtp = new FormData();
                fdKtp.append('foto', fileKtp);
                fdKtp.append('base64', base64Ktp);
                fdKtp.append('creator', user.username);
                
                const resKtp = await fetch('/api/upload-ktp', { method: 'POST', body: fdKtp });
                const jsonKtp = await resKtp.json();

                if (!jsonKtp.success) throw new Error(jsonKtp.error);

                // Buka Modal Konfirmasi
                openDetailModal({
                    ...jsonKtp.data,
                    foto_url: jsonKtp.foto_url,
                    foto_orang_url: fotoOrangUrl,
                    no_hp: hp,
                    jabatan: jab
                }, false); // false = mode Input Baru (bisa edit semua)

            } catch (e) {
                Swal.fire("Error", e.message, "error");
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<i data-lucide="scan-line"></i> Proses Data`;
                lucide.createIcons();
            }
        }

        // --- 3. DETAIL & MODAL ---
        async function openDetailModal(data, isReadOnlyMode) {
            currentDetailId = data.id || null; // Simpan ID jika edit existing

            // Set Gambar
            document.getElementById('displayKtp').src = data.foto_url;
            document.getElementById('editFotoUrl').value = data.foto_url;
            
            const imgOrang = document.getElementById('displayOrang');
            imgOrang.src = data.foto_orang_url || "https://via.placeholder.com/150?text=No+Photo";
            document.getElementById('editFotoOrangUrl').value = data.foto_orang_url || "";

            // Toggle Overlay Edit Foto Orang
            const overlay = document.getElementById('overlayEditFoto');
            if (isReadOnlyMode) {
                overlay.classList.remove('hidden');
                overlay.classList.add('flex');
            } else {
                overlay.classList.add('hidden');
                overlay.classList.remove('flex');
            }

            // Fill Form
            document.getElementById('editNik').value = data.nik || "";
            document.getElementById('editNama').value = data.nama || "";
            document.getElementById('editTempatLahir').value = data.tempat_lahir || "";
            document.getElementById('editTglLahir').value = data.tanggal_lahir || "";
            document.getElementById('editAlamat').value = data.alamat || "";
            document.getElementById('editNoHp').value = data.no_hp || "";
            document.getElementById('editJabatan').value = data.jabatan || "Anggota";

            // Kunci Field jika ReadOnly (Detail Mode)
            const fields = document.querySelectorAll('.input-field');
            fields.forEach(f => f.readOnly = isReadOnlyMode);
            
            // Tombol Simpan
            const btnSimpan = document.getElementById('btnSimpan');
            if (isReadOnlyMode) {
                btnSimpan.classList.add('hidden');
                document.getElementById('modalTitle').innerText = "Detail Data";
            } else {
                btnSimpan.classList.remove('hidden');
                document.getElementById('modalTitle').innerText = "Konfirmasi Data";
                // Auto Match Kecamatan (Logic sama seperti sebelumnya)
                autoMatchLocation(data);
            }

            // Handle Lokasi untuk View Mode
            if(isReadOnlyMode) {
                // Load opsi tapi set value dan disable
                await loadDesaOptions(data.kode_kec || ""); // kode_kec harus ada di data list
                document.getElementById('editKec').value = data.kode_kec || ""; // Perlu logic ekstra untuk ambil kode_kec jika tidak tersedia langsung
                // Simplified: Just show text if needed, or allow edit dropdown to show selected
            }

            document.getElementById('modalConfirm').classList.remove('hidden');
        }

        async function autoMatchLocation(data) {
             const textKec = (data.kecamatan || "").toLowerCase().replace("kecamatan", "").trim();
             const match = listKecamatan.find(k => k.nama_kecamatan.toLowerCase().includes(textKec));
             if(match) {
                 document.getElementById('editKec').value = match.kode_kec;
                 await loadDesaOptions(match.kode_kec, data.kelurahan);
             }
        }

        async function loadDesaOptions(kodeKec, autoSelectName = null) {
            const selDesa = document.getElementById('editDesa');
            selDesa.innerHTML = '<option>Loading...</option>';
            try {
                const res = await fetch(`/api/locations?type=desa&parent=${kodeKec}`);
                const desas = await res.json();
                selDesa.innerHTML = '<option value="">- Pilih Desa -</option>';
                desas.forEach(d => {
                    const sel = (autoSelectName && d.nama_desa.toLowerCase().includes(autoSelectName.toLowerCase().replace(/(desa|kelurahan)/g,"").trim())) ? 'selected' : '';
                    selDesa.innerHTML += `<option value="${d.kode_desa_lengkap}" ${sel}>${d.nama_desa}</option>`;
                });
            } catch(e) {}
        }

        // --- 4. UPDATE FOTO ORANG (DETAIL MODE) ---
        async function uploadNewFotoOrang(input) {
            if (!input.files || !input.files[0]) return;
            
            const loading = Swal.fire({title: 'Mengupdate Foto...', allowOutsideClick: false, didOpen: () => Swal.showLoading()});
            
            try {
                const fd = new FormData();
                fd.append('file', input.files[0]);
                const res = await fetch('/api/upload-simple', { method: 'POST', body: fd });
                const json = await res.json();
                
                if (json.success) {
                    // Update Database
                    await fetch('/api/update-foto-orang', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ id: currentDetailId, foto_url: json.url })
                    });
                    
                    document.getElementById('displayOrang').src = json.url;
                    loadMyData(); // Refresh list background
                    loading.close();
                    Swal.fire("Sukses", "Foto berhasil diubah", "success");
                }
            } catch (e) { loading.close(); Swal.fire("Gagal", e.message, "error"); }
        }

        async function hapusFotoOrang() {
            if(!confirm("Hapus foto orang ini?")) return;
            // Kirim update url kosong
             await fetch('/api/update-foto-orang', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id: currentDetailId, foto_url: "" })
            });
            document.getElementById('displayOrang').src = "https://via.placeholder.com/150?text=No+Photo";
            loadMyData();
        }

        // --- 5. SIMPAN BARU ---
        async function simpanFinal() {
            // ... (Logic simpan sama seperti sebelumnya, pastikan ambil foto_orang_url) ...
            const payload = {
                nik: document.getElementById('editNik').value,
                nama: document.getElementById('editNama').value,
                // ... fields lain ...
                kode_desa_lengkap: document.getElementById('editDesa').value,
                nama_desa: document.getElementById('editDesa').options[document.getElementById('editDesa').selectedIndex]?.text,
                foto_url: document.getElementById('editFotoUrl').value,
                foto_orang_url: document.getElementById('editFotoOrangUrl').value, // NEW
                no_hp: document.getElementById('editNoHp').value,
                jabatan: document.getElementById('editJabatan').value,
                // ... location fields ...
                tempat_lahir: document.getElementById('editTempatLahir').value,
                tanggal_lahir: document.getElementById('editTglLahir').value,
                alamat: document.getElementById('editAlamat').value,
                rt: "00", rw: "00", // Simplifikasi jika field hidden
                creator: user.username
            };
            
            // Fetch ke /api/simpan-data ...
            try {
                const res = await fetch('/api/simpan-data', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)});
                const result = await res.json();
                if(result.success) {
                    closeModal();
                    Swal.fire("Berhasil", "Data disimpan", "success");
                    navTo('hasil'); // Pindah ke tab hasil
                } else throw new Error(result.error);
            } catch(e) { Swal.fire("Gagal", e.message, "error"); }
        }

        function closeModal() { document.getElementById('modalConfirm').classList.add('hidden'); }

        // --- 6. LIST DATA & PAGINASI ---
        async function loadMyData() {
            document.getElementById('listContainer').innerHTML = '<div class="text-center py-10"><span class="animate-spin">ðŸŒ€</span></div>';
            const res = await fetch(`/api/my-data?user=${user.username}`);
            allData = await res.json();
            
            document.getElementById('dashTotal').innerText = allData.length;
            renderList();
        }

        function renderList() {
            const container = document.getElementById('listContainer');
            container.innerHTML = "";
            
            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const paginatedData = allData.slice(start, end);
            
            if (paginatedData.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-400 py-10">Belum ada data</p>';
                return;
            }

            paginatedData.forEach(item => {
                // Item List
                container.innerHTML += `
                    <div onclick='openDetailFromList(${JSON.stringify(item)})' class="bg-white p-3 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-3 active:scale-95 transition-transform cursor-pointer">
                        <img src="${item.foto_url}" class="w-12 h-12 rounded-lg object-cover bg-slate-100">
                        <div class="flex-1 min-w-0">
                            <p class="font-bold text-slate-800 text-sm truncate">${item.nama}</p>
                            <div class="flex items-center gap-2 text-[10px] text-slate-500 mt-0.5">
                                <span class="bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded font-bold">${item.jabatan}</span>
                                <span class="truncate">${item.nama_desa || 'Cianjur'}</span>
                            </div>
                        </div>
                        <i data-lucide="chevron-right" class="w-4 h-4 text-slate-300"></i>
                    </div>
                `;
            });

            // Update Pagination UI
            document.getElementById('pageInfo').innerText = `Hal ${currentPage} dari ${Math.ceil(allData.length / rowsPerPage)}`;
            document.getElementById('btnPrev').disabled = currentPage === 1;
            document.getElementById('btnNext').disabled = end >= allData.length;
            document.getElementById('pagination').classList.remove('hidden');
            lucide.createIcons();
        }

        function openDetailFromList(item) {
            // Perlu trick untuk kirim data lengkap ke modal readonly
            // Karena API my-data mungkin perlu join kecamatan kode untuk dropdown
            // Untuk simplifikasi, kita asumsikan item punya semua field atau fetch ulang by ID jika perlu
            openDetailModal(item, true); // true = ReadOnly
        }

        function nextPage() { if ((currentPage * rowsPerPage) < allData.length) { currentPage++; renderList(); } }
        function prevPage() { if (currentPage > 1) { currentPage--; renderList(); } }
        
        function logout() { localStorage.clear(); window.location.href='/index.html'; }
    </script>
</body>
</html>
